# A2A Protocol Plugin for OpenCode

This plugin provides OpenCode with support for the A2A (Agent-to-Agent) Protocol, enabling communication with other A2A-compatible agents and optionally exposing OpenCode as an A2A server.

## Features

- **A2A Client**: Connect to and communicate with any A2A-compatible agent
- **A2A Server**: Expose OpenCode as an A2A agent for other agents to interact with
- **Agent Discovery**: Fetch and parse Agent Cards from remote agents
- **Streaming Support**: Real-time streaming of agent responses
- **Authentication**: Support for Bearer tokens and API keys

## Installation

```bash
cd ~/.config/opencode/plugins/a2a
npm install
```

## Configuration

Add the plugin to your `opencode.json`:

```json
{
  "plugin": [
    "./plugins/a2a"
  ],
  "a2a": {
    "agentUrl": "http://localhost:4000",
    "authToken": "your-auth-token"
  }
}
```

### Configuration Options

| Option | Type | Description |
|--------|------|-------------|
| `agentUrl` | string | Default A2A agent URL to connect to |
| `agentCardUrl` | string | Agent Card URL for agent discovery |
| `authToken` | string | Bearer token for authentication |
| `apiKey` | string | API key for authentication |
| `serverMode` | boolean | Enable A2A server mode (default: false) |
| `port` | number | Server port (default: 4000) |
| `host` | string | Server host (default: localhost) |
| `serverUrl` | string | Public URL of the A2A server |
| `agentName` | string | Name of the OpenCode agent (server mode) |
| `agentDescription` | string | Description of the agent |
| `streaming` | boolean | Enable streaming (default: true) |
| `pushNotifications` | boolean | Enable push notifications (default: false) |

## Usage

### As A2A Client

The plugin automatically creates an A2A client when `agentUrl` is configured. You can use the exported functions:

```typescript
import { createA2AClient, sendToA2AAgent, fetchAgentCard } from "./plugins/a2a";

// Connect to an A2A agent
const client = await createA2AClient(
  "http://localhost:4000",
  "your-auth-token"
);

// Send a message
const response = await sendToA2AAgent(client, "Hello, agent!");

// Get response text
if (response.kind === "message") {
  console.log(response.parts[0].text);
}

// Stream responses
for await (const event of streamFromA2AAgent(client, "Tell me a story")) {
  console.log(event.status.state);
}

// Fetch agent capabilities
const agentCard = await fetchAgentCard("http://localhost:4000");
console.log(agentCard.skills);
```

### As A2A Server

Enable server mode to make OpenCode available as an A2A agent:

```json
{
  "a2a": {
    "serverMode": true,
    "port": 4000,
    "host": "localhost",
    "agentName": "OpenCode Assistant",
    "agentDescription": "AI coding assistant powered by OpenCode"
  }
}
```

The server exposes:
- `/.well-known/agent-card.json` - Agent Card endpoint
- `/a2a/jsonrpc` - JSON-RPC endpoint
- `/a2a/rest` - REST endpoint

### Example: Connecting to Another Agent

```typescript
// In your plugin or script
import { createA2AClient, sendToA2AAgent } from "./plugins/a2a";

async function queryExternalAgent(prompt: string) {
  const client = await createA2AClient(
    "https://agent.example.com",
    process.env.A2A_TOKEN
  );
  
  const result = await sendToA2AAgent(client, prompt);
  
  return result;
}
```

## A2A Protocol Reference

This plugin implements A2A Protocol v0.3.0. For details see:
- Specification: https://a.org/v0.2a-protocol3.0/specification/
- JavaScript SDK: https://github.com/a2aproject/a2a-js

### Key Concepts

- **Agent Card**: JSON metadata describing agent capabilities
- **Task**: Stateful unit of work with lifecycle states
- **Message**: Communication between client and agent
- **Part**: Content unit (text, file, data)
- **Artifact**: Output generated by agent

### Supported Methods

- `message/send` - Send message to agent
- `message/stream` - Stream message responses
- `tasks/get` - Get task status
- `tasks/cancel` - Cancel running task
- `agent/getAuthenticatedExtendedCard` - Get agent card

## Skills

When in server mode, OpenCode exposes these skills:

| Skill ID | Name | Description |
|----------|------|-------------|
| `code-assistance` | Code Assistance | Help with coding tasks |
| `code-review` | Code Review | Review code for issues |
| `refactoring` | Refactoring | Refactor code |

## Troubleshooting

### Connection Issues

If you can't connect to an agent:
1. Verify the agent URL is correct
2. Check authentication credentials
3. Ensure the agent is running and accessible

### Server Not Starting

Check that the port is not already in use:
```bash
lsof -i :4000
```

### Authentication Errors

Ensure your auth token or API key is correctly configured and has necessary permissions.
