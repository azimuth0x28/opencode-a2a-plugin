# A2A Protocol Plugin for OpenCode

This plugin provides OpenCode with support for the A2A (Agent-to-Agent) Protocol, enabling communication with other A2A-compatible agents and optionally exposing OpenCode as an A2A server.

## Features

- **A2A Client**: Connect to and communicate with any A2A-compatible agent
- **A2A Server**: Expose OpenCode as an A2A agent for other agents to interact with
- **Agent Discovery**: Fetch and parse Agent Cards from remote agents
- **Streaming Support**: Real-time streaming of agent responses
- **Authentication**: Support for Bearer tokens and API keys
- **Custom Tools**: Built-in tools for agent interaction

## Installation

```bash
cd ~/.config/opencode/plugin/a2a
npm install
npm run build
```

## Configuration

Add the plugin to your `opencode.jsonc`:

```jsonc
{
  "plugin": [
    "./plugin/a2a"
  ]
}
```

Create `~/.config/opencode/a2a.jsonc`:

```jsonc
{
  // A2A Agent URL to connect to
  "agentUrl": "http://localhost:4000",
  
  // Authentication
  "authToken": "",
  "apiKey": "",
  
  // Enable server mode to expose OpenCode as A2A agent
  "serverMode": true,
  
  // Server configuration
  "port": 4000,
  "host": "localhost",
  
  // Agent identity
  "agentName": "OpenCode Agent",
  "agentDescription": "OpenCode AI coding assistant",
  
  // Features
  "streaming": true,
  "pushNotifications": false
}
```

### Configuration Options

| Option | Type | Default | Description |
|--------|------|---------|-------------|
| `agentUrl` | string | - | Default A2A agent URL to connect to |
| `agentCardUrl` | string | - | Agent Card URL for agent discovery |
| `authToken` | string | - | Bearer token for authentication |
| `apiKey` | string | - | API key for authentication |
| `serverMode` | boolean | false | Enable A2A server mode |
| `port` | number | 4000 | Server port (1-65535) |
| `host` | string | localhost | Server host |
| `serverUrl` | string | - | Public URL of the A2A server |
| `agentName` | string | OpenCode Agent | Name of the agent |
| `agentDescription` | string | - | Description of the agent |
| `streaming` | boolean | true | Enable streaming |
| `pushNotifications` | boolean | false | Enable push notifications |

## Tools

The plugin provides 4 OpenCode tools:

| Tool | Description |
|------|-------------|
| `a2a_send` | Send message to A2A agent and get response |
| `a2a_discover` | Fetch and display agent capabilities from Agent Card |
| `a2a_task_status` | Get status of a running task |
| `a2a_cancel` | Cancel a running task |

### Usage Examples

```
# Send message to A2A agent
a2a_send message: "Hello, help me with this code..."

# Discover agent capabilities
a2a_discover agentUrl: "http://localhost:4000"

# Get task status
a2a_task_status taskId: "task-123"

# Cancel task
a2a_cancel taskId: "task-123"
```

## Server Endpoints

When server mode is enabled:

| Endpoint | Method | Description |
|----------|--------|-------------|
| `/.well-known/agent-card.json` | GET | Agent Card (discovery) |
| `/a2a/jsonrpc` | POST | JSON-RPC transport |
| `/a2a/rest` | POST | HTTP+JSON/REST transport |

### JSON-RPC Methods

| Method | Description |
|--------|-------------|
| `message/send` | Send message, returns Message or Task |
| `tasks/get` | Get task by ID |
| `tasks/cancel` | Cancel a running task |

### REST Endpoints

| Endpoint | Method | Description |
|----------|--------|-------------|
| `/v1/card` | GET | Get Agent Card |
| `/v1/messages:send` | POST | Send message |
| `/v1/messages:stream` | POST | Stream messages |
| `/v1/tasks/:id` | GET | Get task |
| `/v1/tasks/:id:cancel` | POST | Cancel task |

## Standalone Server

You can run the A2A server as a standalone process:

```bash
cd plugin/a2a
node server.mjs
```

With environment variables:

```bash
A2A_PORT=4001 A2A_HOST=0.0.0.0 A2A_AGENT_NAME="My Agent" node server.mjs
```

## A2A Protocol Reference

This plugin implements A2A Protocol v0.3.0.

- Specification: https://a2a-protocol.org/v0.3.0/specification/
- JavaScript SDK: https://github.com/a2aproject/a2a-js

### Key Concepts

- **Agent Card**: JSON metadata describing agent capabilities
- **Task**: Stateful unit of work with lifecycle states
- **Message**: Communication between client and agent
- **Part**: Content unit (text, file, data)
- **Artifact**: Output generated by agent

### Exposed Skills (Server Mode)

| Skill ID | Name | Description |
|----------|------|-------------|
| `code-assistance` | Code Assistance | Help with coding tasks |
| `code-review` | Code Review | Review code for issues |
| `refactoring` | Refactoring | Refactor code |

## Troubleshooting

### Connection Issues

1. Verify the agent URL is correct
2. Check authentication credentials
3. Ensure the agent is running and accessible

### Server Not Starting

Check that the port is not already in use:

```bash
lsof -i :4000
```

### Authentication Errors

Ensure your auth token or API key is correctly configured.